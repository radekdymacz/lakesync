name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run lint

  typecheck:
    name: Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - run: bun run test

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    env:
      MINIO_ENDPOINT: http://localhost:9000
      MINIO_ROOT_USER: lakesync
      MINIO_ROOT_PASSWORD: lakesync123
      NESSIE_URI: http://localhost:19120/iceberg
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install --frozen-lockfile
      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 \
            -e MINIO_ROOT_USER=lakesync \
            -e MINIO_ROOT_PASSWORD=lakesync123 \
            quay.io/minio/minio:latest server /data
      - name: Start Nessie
        run: |
          docker run -d --name nessie \
            -p 19120:19120 \
            -e NESSIE_VERSION_STORE_TYPE=IN_MEMORY \
            -e NESSIE_CATALOG_DEFAULT_WAREHOUSE=s3://lakesync-test \
            ghcr.io/projectnessie/nessie:latest
      - name: Wait for Nessie
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:19120/iceberg/v1/config; then
              break
            fi
            sleep 1
          done
      - name: Wait for MinIO and create bucket
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:9000/minio/health/live; then
              break
            fi
            sleep 1
          done
          curl -sL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc
          chmod +x /usr/local/bin/mc
          mc alias set local http://localhost:9000 lakesync lakesync123
          mc mb --ignore-existing local/lakesync-dev
      - run: bun run test:integration
