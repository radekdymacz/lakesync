---
title: Client SDK
description: API reference for @lakesync/client — LocalDB, SyncCoordinator, transports, and queues.
---

The `@lakesync/client` package provides the browser-side SDK for building local-first applications with LakeSync.

## LocalDB

SQLite database running in the browser via sql.js WASM, with IndexedDB snapshot persistence.

### `LocalDB.create()`

```ts
class LocalDB {
  static create(): Promise<LocalDB>;
  exec(sql: string, params?: unknown[]): void;
  query<T>(sql: string, params?: unknown[]): T[];
  snapshot(): Uint8Array;
  restore(data: Uint8Array): void;
}
```

- **`exec(sql, params?)`** — Execute a SQL statement (DDL or DML).
- **`query(sql, params?)`** — Execute a SQL query and return rows.
- **`snapshot()`** — Export the full database as a binary snapshot.
- **`restore(data)`** — Replace the database contents from a snapshot.

## SyncTracker

Wraps a `LocalDB`, a queue, and an HLC to automatically extract deltas from mutations.

```ts
class SyncTracker {
  constructor(
    db: LocalDB,
    queue: SyncQueue,
    hlc: HLC,
    clientId: string,
  );
  insert(table: string, row: Record<string, unknown>): void;
  update(table: string, rowId: string, changes: Record<string, unknown>): void;
  delete(table: string, rowId: string): void;
}
```

Each mutation is recorded as a `Delta` and enqueued for sync.

## SyncCoordinator

Orchestrates push/pull sync between the local database and a remote gateway.

### Constructor

```ts
class SyncCoordinator {
  constructor(config: SyncCoordinatorConfig);
  push(): Promise<Result<void, string>>;
  pull(): Promise<Result<void, string>>;
  start(): void;
  stop(): void;
}
```

### `SyncCoordinatorConfig`

```ts
interface SyncCoordinatorConfig {
  queue?: SyncQueue;
  hlc?: HLC;
  clientId?: string;
  maxRetries?: number;
  syncMode?: SyncMode;
  autoSyncIntervalMs?: number;       // default 10000 (10s)
  realtimeHeartbeatMs?: number;       // default 60000 (60s)
}
```

- **`autoSyncIntervalMs`** — Polling interval for HTTP transports. Default 10 seconds.
- **`realtimeHeartbeatMs`** — Polling interval when a realtime transport is active. Default 60 seconds. Acts as a safety net for deltas missed during brief disconnects.

### `SyncMode`

```ts
type SyncMode = "full" | "pushOnly" | "pullOnly";
```

- **`full`** — Push and pull on each sync cycle (default).
- **`pushOnly`** — Only push local deltas. Useful for write-only producers.
- **`pullOnly`** — Only pull remote deltas. Useful for read-only consumers.

## Transports

### `SyncTransport` (interface)

```ts
interface SyncTransport {
  push(msg: SyncPush): Promise<Result<{ serverHlc: HLCTimestamp; accepted: number }, LakeSyncError>>;
  pull(msg: SyncPull): Promise<Result<SyncResponse, LakeSyncError>>;
  checkpoint?(): Promise<Result<CheckpointResponse | null, LakeSyncError>>;

  /** Whether this transport supports real-time server push. */
  readonly supportsRealtime?: boolean;
  /** Register callback for server-initiated broadcasts. */
  onBroadcast?(callback: (deltas: RowDelta[], serverHlc: HLCTimestamp) => void): void;
  /** Connect persistent transport (e.g. open WebSocket). */
  connect?(): void;
  /** Disconnect persistent transport (e.g. close WebSocket). */
  disconnect?(): void;
}
```

The optional realtime members (`supportsRealtime`, `onBroadcast`, `connect`, `disconnect`) are implemented by `WebSocketTransport`. Polling transports (`HttpTransport`, `LocalTransport`) ignore them.

### `LocalTransport`

In-process transport for development and testing. Connects directly to a `Gateway` instance.

```ts
class LocalTransport implements SyncTransport {
  constructor(gateway: LocalGateway, clientId: string);
}
```

### `HttpTransport`

Remote transport that communicates with a gateway over HTTP.

```ts
class HttpTransport implements SyncTransport {
  constructor(config: HttpTransportConfig);
}

interface HttpTransportConfig {
  baseUrl: string;
  gatewayId: string;
  getToken: () => Promise<string>;
}
```

### `WebSocketTransport`

Real-time transport using a persistent WebSocket connection. Supports server-initiated broadcast for sub-second sync latency.

```ts
class WebSocketTransport implements SyncTransport {
  constructor(config: WebSocketTransportConfig);

  /** Whether the WebSocket is currently connected. */
  readonly connected: boolean;
  /** Always true — this transport supports real-time. */
  readonly supportsRealtime: boolean;

  connect(): void;
  disconnect(): void;
  onBroadcast(callback: (deltas: RowDelta[], serverHlc: HLCTimestamp) => void): void;
}

interface WebSocketTransportConfig {
  url: string;
  token: string;
  onBroadcast?: (deltas: RowDelta[], serverHlc: HLCTimestamp) => void;
  reconnectBaseMs?: number;   // default 1000
  reconnectMaxMs?: number;    // default 30000
  httpConfig?: HttpTransportConfig;
}
```

- **`url`** — WebSocket endpoint, e.g. `"wss://gateway.example.com/sync/gw-1/ws"`.
- **`token`** — JWT token, passed as `?token=` query parameter (browser WebSocket cannot set headers).
- **`httpConfig`** — When provided, `checkpoint()` delegates to an internal `HttpTransport`. Without it, checkpoint returns `null`.
- **Auto-reconnect** — On disconnect, reconnects with exponential backoff (1s base, 30s max). Resets on successful connection.

See [Real-Time Sync](/docs/real-time) for a full guide.

## Queues

### `MemoryQueue`

In-memory queue for development and testing. Deltas are lost on page refresh.

```ts
class MemoryQueue implements SyncQueue {
  enqueue(delta: Delta): void;
  dequeueAll(): Delta[];
  peek(): Delta[];
}
```

### `IDBQueue`

IndexedDB-backed queue for production use. Persists deltas across page refreshes.

```ts
class IDBQueue implements SyncQueue {
  static create(dbName?: string): Promise<IDBQueue>;
  enqueue(delta: Delta): void;
  dequeueAll(): Delta[];
  peek(): Delta[];
}
```

Note: `IDBQueue` serialises `HLCTimestamp` to string internally because IndexedDB's `structuredClone` cannot handle `bigint`.

## Schema Synchronisation

### `SchemaSynchroniser`

Handles client-side schema migrations by comparing local table schemas against the gateway's schema.

```ts
class SchemaSynchroniser {
  constructor(db: LocalDB);
  synchronise(schemas: TableSchema[]): void;
}
```
